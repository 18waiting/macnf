# Koloda ç´¢å¼•åŒæ­¥æ–¹æ¡ˆåˆ†æž

## ðŸ“Š å½“å‰æ–¹æ¡ˆçš„é—®é¢˜åˆ†æž

### 1. **æ€§èƒ½é—®é¢˜**
- âŒ **åˆ›å»ºå¤§é‡æ— ç”¨è§†å›¾**ï¼šå½“ `offset=23` æ—¶ï¼ŒKoloda ä¼šåˆ›å»º 23 ä¸ªé€æ˜Žå ä½å¡ç‰‡è§†å›¾
- âŒ **å†…å­˜æµªè´¹**ï¼šè¿™äº›å ä½è§†å›¾è™½ç„¶é€æ˜Žï¼Œä½†ä»ç„¶å ç”¨å†…å­˜å’Œ CPU èµ„æº
- âŒ **åˆå§‹åŒ–å»¶è¿Ÿ**ï¼šKoloda éœ€è¦é€ä¸ªè¯·æ±‚ç´¢å¼• 0-22ï¼Œç„¶åŽæ‰æ‰¾åˆ°æœ‰æ•ˆå¡ç‰‡ï¼Œå¯¼è‡´é¦–æ¬¡æ˜¾ç¤ºå»¶è¿Ÿ

### 2. **æž¶æž„é—®é¢˜**
- âŒ **è¿åå•ä¸€èŒè´£åŽŸåˆ™**ï¼š`viewForCardAt` éœ€è¦å¤„ç†ä¸¤ç§ä¸åŒçš„é€»è¾‘ï¼ˆå ä½å¡ç‰‡ vs çœŸå®žå¡ç‰‡ï¼‰
- âŒ **ä»£ç å¤æ‚åº¦å¢žåŠ **ï¼šéœ€è¦ç»´æŠ¤å ä½ Word å¯¹è±¡å’Œç‰¹æ®Šå¤„ç†é€»è¾‘
- âŒ **å¯ç»´æŠ¤æ€§å·®**ï¼šæœªæ¥ä¿®æ”¹æ—¶å®¹æ˜“å‡ºé”™

### 3. **ç”¨æˆ·ä½“éªŒé—®é¢˜**
- âš ï¸ **æ½œåœ¨é—ªçƒ**ï¼šè™½ç„¶å ä½å¡ç‰‡é€æ˜Žï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½çŸ­æš‚å¯è§
- âš ï¸ **åŠ è½½å»¶è¿Ÿ**ï¼šéœ€è¦è·³è¿‡å¤šä¸ªå ä½å¡ç‰‡æ‰èƒ½æ˜¾ç¤ºçœŸå®žå†…å®¹

---

## ðŸ† å•†ä¸šåº”ç”¨çš„æœ€ä½³å®žè·µ

### å‚è€ƒæ¡ˆä¾‹ï¼šTinderã€æŽ¢æŽ¢ã€Bumble

è¿™äº›åº”ç”¨çš„å¤„ç†æ–¹å¼ï¼š
1. **ç›´æŽ¥ç´¢å¼•æ˜ å°„**ï¼šå¡ç‰‡ç´¢å¼•ç›´æŽ¥å¯¹åº”æ•°æ®ç´¢å¼•ï¼Œä¸éœ€è¦åç§»é‡
2. **çŠ¶æ€æŒä¹…åŒ–**ï¼šé€€å‡ºæ—¶ä¿å­˜å½“å‰ç´¢å¼•ï¼Œè¿›å…¥æ—¶æ¢å¤
3. **æ‡’åŠ è½½ä¼˜åŒ–**ï¼šåªåŠ è½½å¯è§å¡ç‰‡ï¼Œä¸é¢„åŠ è½½å ä½å¡ç‰‡

---

## ðŸ’¡ æ›´å¥½çš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šåŠ¨æ€è°ƒæ•´ `kolodaNumberOfCards`ï¼ˆæŽ¨è â­â­â­â­â­ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šè®© Koloda çš„ç´¢å¼•èŒƒå›´ç›´æŽ¥å¯¹åº”é˜Ÿåˆ—ç´¢å¼•ï¼Œä¸éœ€è¦åç§»é‡æ˜ å°„ã€‚

```swift
func kolodaNumberOfCards(_ koloda: KolodaView) -> Int {
    // ç›´æŽ¥è¿”å›žå½“å‰é˜Ÿåˆ—æ•°ï¼Œè€Œä¸æ˜¯åˆå§‹æ€»æ•°
    // è¿™æ · Koloda çš„ç´¢å¼•èŒƒå›´æ˜¯ 0 åˆ° queueCount-1ï¼Œç›´æŽ¥å¯¹åº”é˜Ÿåˆ—ç´¢å¼•
    return viewModel?.queueCount ?? 0
}

func koloda(_ koloda: KolodaView, viewForCardAt index: Int) -> UIView {
    // ç›´æŽ¥ä½¿ç”¨ index ä½œä¸ºé˜Ÿåˆ—ç´¢å¼•ï¼Œä¸éœ€è¦åç§»é‡æ˜ å°„
    guard let viewModel = viewModel,
          index >= 0 && index < viewModel.queueCount,
          let card = viewModel.getCard(at: index) else {
        return UIView()
    }
    // ... åˆ›å»ºå¡ç‰‡è§†å›¾
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… **é›¶æ€§èƒ½å¼€é”€**ï¼šä¸éœ€è¦åˆ›å»ºå ä½å¡ç‰‡
- âœ… **ä»£ç ç®€æ´**ï¼šä¸éœ€è¦åç§»é‡æ˜ å°„é€»è¾‘
- âœ… **å³æ—¶æ˜¾ç¤º**ï¼šKoloda ç›´æŽ¥ä»Žç´¢å¼• 0 å¼€å§‹ï¼Œç«‹å³æ˜¾ç¤ºæœ‰æ•ˆå¡ç‰‡
- âœ… **æ˜“äºŽç»´æŠ¤**ï¼šé€»è¾‘æ¸…æ™°ï¼Œç¬¦åˆç›´è§‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ **ä¸¢å¤±å·²å®Œæˆå¡ç‰‡æ•°ä¿¡æ¯**ï¼š`initialTotalCount` ä¸å†ç”¨äºŽ Kolodaï¼Œä½†å¯ä»¥ç”¨äºŽè¿›åº¦æ˜¾ç¤º

**å®žçŽ°å»ºè®®**ï¼š
- ä¿ç•™ `initialTotalCount` ç”¨äºŽè¿›åº¦è®¡ç®—ï¼ˆ`completedCount / initialTotalCount`ï¼‰
- ä½† `kolodaNumberOfCards` è¿”å›ž `queueCount`
- ç§»é™¤æ‰€æœ‰åç§»é‡æ˜ å°„é€»è¾‘

---

### æ–¹æ¡ˆ 2ï¼šçŠ¶æ€æŒä¹…åŒ– + ç´¢å¼•æ¢å¤ï¼ˆæŽ¨è â­â­â­â­ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šé€€å‡ºæ—¶ä¿å­˜ Koloda çš„ `currentCardIndex`ï¼Œè¿›å…¥æ—¶æ¢å¤ã€‚

```swift
// åœ¨ ViewModel ä¸­ä¿å­˜
var savedKolodaIndex: Int = 0

// é€€å‡ºæ—¶ä¿å­˜
func saveCurrentIndex(_ index: Int) {
    savedKolodaIndex = index
}

// è¿›å…¥æ—¶æ¢å¤ï¼ˆéœ€è¦ä¿®æ”¹ Koloda æºç æˆ–ä½¿ç”¨ KVCï¼‰
func restoreIndex() {
    // é€šè¿‡åå°„æˆ–æ‰©å±•è®¾ç½® currentCardIndex
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… **å®Œç¾Žæ¢å¤**ï¼šç”¨æˆ·é€€å‡ºæ—¶çš„ä½ç½®å®Œå…¨æ¢å¤
- âœ… **ç”¨æˆ·ä½“éªŒå¥½**ï¼šæ— ç¼è¡”æŽ¥

**ç¼ºç‚¹**ï¼š
- âŒ **éœ€è¦ä¿®æ”¹ Koloda æºç **ï¼š`currentCardIndex` æ˜¯ `private(set)`
- âŒ **å®žçŽ°å¤æ‚**ï¼šéœ€è¦ä½¿ç”¨ KVC æˆ–ä¿®æ”¹ç¬¬ä¸‰æ–¹åº“

---

### æ–¹æ¡ˆ 3ï¼šè™šæ‹Ÿç´¢å¼•æ˜ å°„ï¼ˆå½“å‰æ–¹æ¡ˆä¼˜åŒ–ç‰ˆ â­â­â­ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šä¼˜åŒ–å½“å‰æ–¹æ¡ˆï¼Œå‡å°‘å ä½å¡ç‰‡çš„åˆ›å»ºã€‚

```swift
// ä½¿ç”¨è½»é‡çº§å ä½è§†å›¾ï¼Œä¸åˆ›å»ºå®Œæ•´å¡ç‰‡
func koloda(_ koloda: KolodaView, viewForCardAt index: Int) -> UIView {
    let queueIndex = index - currentOffset
    
    if queueIndex < 0 {
        // è¿”å›žæœ€å°åŒ–çš„å ä½è§†å›¾ï¼ˆä¸åˆ›å»º WordCardUIViewï¼‰
        let placeholder = UIView()
        placeholder.frame = CGRect(x: 0, y: 0, width: 1, height: 1)
        placeholder.alpha = 0
        return placeholder
    }
    // ... æ­£å¸¸å¤„ç†
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… **æœ€å°åŒ–èµ„æºå ç”¨**ï¼šå ä½è§†å›¾å‡ ä¹Žä¸å ç”¨èµ„æº
- âœ… **ä¿æŒçŽ°æœ‰æž¶æž„**ï¼šä¸éœ€è¦å¤§å¹…ä¿®æ”¹ä»£ç 

**ç¼ºç‚¹**ï¼š
- âš ï¸ **ä»ç„¶æœ‰æ€§èƒ½å¼€é”€**ï¼šéœ€è¦åˆ›å»ºå¤šä¸ªå ä½è§†å›¾
- âš ï¸ **åˆå§‹åŒ–å»¶è¿Ÿ**ï¼šä»ç„¶éœ€è¦è·³è¿‡å¤šä¸ªç´¢å¼•

---

## ðŸŽ¯ æœ€ç»ˆæŽ¨è

### **æ–¹æ¡ˆ 1ï¼šåŠ¨æ€è°ƒæ•´ `kolodaNumberOfCards`**

è¿™æ˜¯æœ€ç¬¦åˆå•†ä¸šåº”ç”¨æ ‡å‡†çš„æ–¹æ¡ˆï¼š

1. **æ€§èƒ½æœ€ä¼˜**ï¼šé›¶é¢å¤–å¼€é”€
2. **ä»£ç æœ€ç®€æ´**ï¼šç§»é™¤æ‰€æœ‰åç§»é‡æ˜ å°„é€»è¾‘
3. **ç”¨æˆ·ä½“éªŒæœ€å¥½**ï¼šå³æ—¶æ˜¾ç¤ºï¼Œæ— å»¶è¿Ÿ
4. **æ˜“äºŽç»´æŠ¤**ï¼šé€»è¾‘æ¸…æ™°ï¼Œç¬¦åˆç›´è§‰

### å®žçŽ°æ­¥éª¤ï¼š

1. ä¿®æ”¹ `kolodaNumberOfCards` è¿”å›ž `queueCount`
2. ç§»é™¤ `currentOffset` è®¡ç®—å’Œæ‰€æœ‰åç§»é‡æ˜ å°„
3. ç›´æŽ¥ä½¿ç”¨ `index` ä½œä¸ºé˜Ÿåˆ—ç´¢å¼•
4. ä¿ç•™ `initialTotalCount` ä»…ç”¨äºŽè¿›åº¦æ˜¾ç¤º

---

## ðŸ“ ä»£ç å¯¹æ¯”

### å½“å‰æ–¹æ¡ˆï¼ˆå¤æ‚ï¼‰ï¼š
```swift
// éœ€è¦åç§»é‡æ˜ å°„
let queueIndex = index - currentOffset
if queueIndex < 0 {
    // åˆ›å»ºå ä½å¡ç‰‡
    return placeholderView
}
```

### æŽ¨èæ–¹æ¡ˆï¼ˆç®€æ´ï¼‰ï¼š
```swift
// ç›´æŽ¥ä½¿ç”¨ç´¢å¼•
guard index >= 0 && index < viewModel.queueCount,
      let card = viewModel.getCard(at: index) else {
    return UIView()
}
```

---

## âœ… ç»“è®º

**å½“å‰æ–¹æ¡ˆ**è™½ç„¶èƒ½å·¥ä½œï¼Œä½†ä¸ç¬¦åˆå•†ä¸šåº”ç”¨çš„æ ‡å‡†ï¼š
- æ€§èƒ½å¼€é”€å¤§
- ä»£ç å¤æ‚åº¦é«˜
- ç”¨æˆ·ä½“éªŒæœ‰å»¶è¿Ÿ

**æŽ¨èæ–¹æ¡ˆ 1**æ˜¯æœ€ä½³é€‰æ‹©ï¼š
- é›¶æ€§èƒ½å¼€é”€
- ä»£ç ç®€æ´æ¸…æ™°
- å³æ—¶æ˜¾ç¤ºï¼Œç”¨æˆ·ä½“éªŒå¥½
- ç¬¦åˆå•†ä¸šåº”ç”¨æ ‡å‡†

