# 滑卡逻辑优化建议书 (基于 Tinder 架构)

> 本文档基于 [Tinder 架构分析](TINDER_ARCHITECTURE_ANALYSIS.md) 与 [当前项目现状](SWIPE_LOGIC_AND_DATA_FLOW.md) 的对比，提出针对性的优化建议。
> **核心目标**：在保持现有业务逻辑（背单词）完整性的前提下，引入商业级应用的架构模式，提升性能、可维护性及用户体验。

## 1. 数据结构优化建议

### 1.1 引入双端队列 (Deque)
**现状**: 使用标准数组 `[StudyCard]` 作为队列，移除头部元素 `removeFirst()` 的时间复杂度为 O(n)。虽然在当前数据量（<100）下性能影响微乎其微，但从架构严谨性角度看并非最优。
**建议**:
*   引入 `Deque` (双端队列) 数据结构。
*   **优势**: 头部移除操作复杂度降为 O(1)。
*   **场景**: 未来如果支持“撤销”功能，需要将卡片插回头部，Deque 是必须的。

### 1.2 引入历史栈 (History Stack)
**现状**: 只有 `learningRecords` 记录状态，没有专门的“历史操作栈”。
**建议**:
*   新增 `historyStack: Stack<HistoryItem>`。
*   `HistoryItem` 记录：`{ cardId, action (left/right), timestamp }`。
*   **价值**:
    1.  **支持撤销**: 允许用户撤回上一次误操作（背单词场景下非常实用）。
    2.  **数据回滚**: 撤销时可根据 HistoryItem 精确回滚 `learningRecords` 中的计数。

---

## 2. 状态管理优化建议

### 2.1 显式状态机 (Explicit State Machine)
**现状**: 状态分散在 `isExpanded`, `offset` 等多个独立变量中，缺乏统一管理。
**建议**:
*   在 `SwipeCardsView` 或 `InteractiveCard` 中引入明确的状态枚举：
    ```swift
    enum CardState {
        case idle           // 静止
        case dragging       // 拖拽中
        case animatingOut   // 飞出动画中
        case rewinding      // 撤销动画中
    }
    ```
*   **价值**: 防止状态冲突。例如，在 `animatingOut` 过程中禁止用户再次触摸或触发点击展开。

### 2.2 预加载水位线 (Prefetch Watermark)
**现状**: 一次性加载整个 Task 的卡片（如 50 张）。
**建议**:
*   虽然背单词场景数据量不大，但为了内存优化，建议仅保持 `queue` 中有 10-20 张卡片。
*   设置水位线：当 `queue.count < 5` 时，异步从数据库或生成逻辑中获取更多卡片。
*   **价值**: 减少内存峰值，加快首屏初始化速度。

---

## 3. 交互体验优化建议

### 3.1 乐观 UI 更新 (Optimistic UI)
**现状**: `handleSwipe` 中包含数据库写入和策略检查，虽然是异步的，但逻辑耦合较紧。
**建议**:
*   **UI 优先**: 滑动发生时，UI 立即响应（移除卡片、显示下一张）。
*   **延迟处理**: 数据库写入、策略检查（是否提前掌握）等逻辑放入后台队列，不阻塞 UI 线程。
*   **注意**: 若后台检查发现“提前掌握”，则在下一次 UI 刷新时静默移除相关卡片，而不是立即打断当前动画。

### 3.2 物理动效微调
**现状**: 简单的线性位移和旋转。
**建议**:
*   **锚点调整**: 将旋转锚点（Anchor Point）设为屏幕底部中心，使卡片摆动更像真实手持卡片。
*   **插值优化**: 根据拖拽速度（Velocity）动态调整飞出动画的时长，速度越快飞出越快，而不是固定时长。

---

## 4. 架构分层建议

### 4.1 引入 Coordinator (协调器)
**现状**: `SwipeCardsView` 直接与 `StudyViewModel` 交互。
**建议**:
*   引入 `CardStackCoordinator` 协议。
*   职责：专门处理卡片的流转逻辑（出队、入队、撤销、预加载）。
*   **价值**: 将纯粹的“卡片堆叠逻辑”与“背单词业务逻辑”解耦。`StudyViewModel` 专注背单词业务（记录、掌握度），`Coordinator` 专注卡片怎么动。

---

## 5. 实施路线图 (Roadmap)

如果决定实施上述优化，建议按以下优先级进行：

1.  **P1 (高收益)**: **引入历史栈 (History Stack)**。这是实现“撤销”功能的基础，且对现有逻辑侵入性小，用户感知明显。
2.  **P2 (架构)**: **状态机改造**。提升代码健壮性，减少交互 bug。
3.  **P3 (性能)**: **Deque 和预加载**。在当前数据量下属于锦上添花，可延后。
4.  **P4 (体验)**: **物理动效微调**。

## 总结
当前架构对于 MVP 阶段是合格的。引入 **历史栈** 和 **状态机** 是迈向商业级体验的两个最关键步骤。
