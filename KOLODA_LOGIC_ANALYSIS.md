# ğŸ“Š å•è¯æ»‘å¡é¡µé¢é€»è¾‘åˆ†ææŠ¥å‘Š

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### å±‚æ¬¡ç»“æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   KolodaCardsView (SwiftUI)         â”‚  â† ä¸»è§†å›¾å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   KolodaViewWrapper (æ¡¥æ¥å±‚)         â”‚  â† SwiftUI â†” UIKit æ¡¥æ¥
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   KolodaView (ç¬¬ä¸‰æ–¹åº“)               â”‚  â† å¡ç‰‡å®¹å™¨
â”‚   + KolodaCardsCoordinator           â”‚  â† æ•°æ®æº/å§”æ‰˜åè°ƒå™¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   WordCardUIView (UIKit)             â”‚  â† å•ä¸ªå¡ç‰‡è§†å›¾
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   StudyViewModel (ä¸šåŠ¡é€»è¾‘)           â”‚  â† çŠ¶æ€ç®¡ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®åº“å­˜å‚¨å±‚                        â”‚  â† æŒä¹…åŒ–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ æ•°æ®æµåˆ†æ

### 1. åˆå§‹åŒ–æµç¨‹
```
StudyViewModel.init()
  â”œâ”€ loadCurrentGoalAndTask()          // åŠ è½½ç›®æ ‡å’Œä»»åŠ¡
  â”œâ”€ setupDemoData()                   // åˆå§‹åŒ–é˜Ÿåˆ—
  â”‚   â”œâ”€ fetchStudyCards()             // ä»æ•°æ®åº“è·å–
  â”‚   â”œâ”€ optimizeQueue()               // ä¼˜åŒ–é˜Ÿåˆ—ï¼ˆé¿å…è¿ç»­ç›¸åŒå•è¯ï¼‰
  â”‚   â””â”€ loadNextCards()               // visibleCards = queue.prefix(3)
  â””â”€ startTimer()                      // å¯åŠ¨è®¡æ—¶å™¨

KolodaCardsView.onAppear
  â””â”€ viewModel.startCurrentCardTracking()  // å¼€å§‹è¿½è¸ªç¬¬ä¸€å¼ å¡
```

### 2. æ»‘åŠ¨äº¤äº’æµç¨‹
```
ç”¨æˆ·æ»‘åŠ¨å¡ç‰‡
  â†“
KolodaView æ£€æµ‹æ‰‹åŠ¿
  â†“
KolodaCardsCoordinator.didSwipeCardAt()
  â”œâ”€ è®¡ç®—åœç•™æ—¶é—´ (currentCardStartTime)
  â”œâ”€ è½¬æ¢æ–¹å‘ (SwipeResultDirection â†’ SwipeDirection)
  â””â”€ onSwipe(cardId, direction, dwellTime)
      â†“
KolodaCardsView.handleSwipe()
  â”œâ”€ æŸ¥æ‰¾å¡ç‰‡ (é€šè¿‡ cardId)
  â””â”€ viewModel.handleSwipe(wordId, direction, dwellTime)
      â†“
StudyViewModel.handleSwipe()
  â”œâ”€ æ›´æ–°å­¦ä¹ è®°å½• (learningRecords)
  â”œâ”€ è®°å½•åˆ°æ•°æ®åº“ (eventStorage.recordSwipe)
  â”œâ”€ æ›´æ–°ç»Ÿè®¡ (completedCount, rightSwipeCount, etc.)
  â”œâ”€ æ£€æŸ¥æå‰æŒæ¡ (exposureStrategy.shouldContinueExposure)
  â”œâ”€ ä»é˜Ÿåˆ—ç§»é™¤ (queue.removeFirst)
  â”œâ”€ æ›´æ–°å¯è§å¡ç‰‡ (visibleCards = queue.prefix(3))
  â””â”€ æ£€æŸ¥å®ŒæˆçŠ¶æ€
```

### 3. å¡ç‰‡æ˜¾ç¤ºæµç¨‹
```
KolodaView éœ€è¦å¡ç‰‡
  â†“
KolodaCardsCoordinator.viewForCardAt(index)
  â”œâ”€ æ£€æŸ¥ index < cards.count
  â”œâ”€ åˆ›å»º WordCardUIView()
  â”œâ”€ cardView.configure(with: card)
  â””â”€ å¦‚æœæ˜¯ç¬¬ä¸€å¼ å¡ï¼Œå¼€å§‹è®¡æ—¶
```

## âš ï¸ å‘ç°çš„é—®é¢˜

### ğŸ”´ ä¸¥é‡é—®é¢˜

#### 1. **åœç•™æ—¶é—´è¿½è¸ªé‡å¤**
**é—®é¢˜**ï¼š
- `KolodaCardsCoordinator` è‡ªå·±ç»´æŠ¤ `currentCardIndex` å’Œ `currentCardStartTime`
- `StudyViewModel` ä¹Ÿæœ‰ `DwellTimeTracker` è¿½è¸ªåœç•™æ—¶é—´
- ä¸¤ä¸ªåœ°æ–¹éƒ½åœ¨è¿½è¸ªï¼Œå¯èƒ½å¯¼è‡´ä¸ä¸€è‡´

**ä½ç½®**ï¼š
- `KolodaCardsView.swift:299-300` - Coordinator çš„è®¡æ—¶
- `StudyViewModel.swift:41, 330-335` - ViewModel çš„ DwellTimeTracker

**å½±å“**ï¼š
- æ•°æ®å¯èƒ½ä¸ä¸€è‡´
- ä»£ç å†—ä½™
- ç»´æŠ¤å›°éš¾

**å»ºè®®**ï¼š
- ç»Ÿä¸€ä½¿ç”¨ `StudyViewModel` çš„ `DwellTimeTracker`
- Coordinator åªè´Ÿè´£ä¼ é€’äº‹ä»¶ï¼Œä¸ç®¡ç†çŠ¶æ€

---

#### 2. **æ•°æ®åŒæ­¥é—®é¢˜**
**é—®é¢˜**ï¼š
- `KolodaCardsCoordinator.cards` æ˜¯ Coordinator çš„æœ¬åœ°å‰¯æœ¬
- `StudyViewModel.visibleCards` æ˜¯ ViewModel çš„çŠ¶æ€
- å½“ `visibleCards` æ›´æ–°æ—¶ï¼ŒCoordinator çš„ `cards` å¯èƒ½ä¸åŒæ­¥

**ä½ç½®**ï¼š
- `KolodaCardsView.swift:267-280` - updateUIView ä¸­çš„åŒæ­¥é€»è¾‘
- `KolodaCardsView.swift:295` - Coordinator çš„ cards å±æ€§

**å½±å“**ï¼š
- å¯èƒ½å¯¼è‡´æ˜¾ç¤ºé”™è¯¯çš„å¡ç‰‡
- æ»‘åŠ¨æ—¶å¯èƒ½æ‰¾ä¸åˆ°å¯¹åº”çš„å¡ç‰‡

**å»ºè®®**ï¼š
- Coordinator åº”è¯¥ç›´æ¥ä½¿ç”¨ ViewModel çš„ `visibleCards`ï¼Œè€Œä¸æ˜¯ç»´æŠ¤å‰¯æœ¬
- æˆ–è€…ä½¿ç”¨ `@Published` å±æ€§è§‚å¯Ÿè€…è‡ªåŠ¨åŒæ­¥

---

#### 3. **å¡ç‰‡è§†å›¾é‡å¤åˆ›å»º**
**é—®é¢˜**ï¼š
- æ¯æ¬¡ `viewForCardAt` éƒ½åˆ›å»ºæ–°çš„ `WordCardUIView()`
- Koloda å¯èƒ½ä¼šé‡ç”¨è§†å›¾ï¼Œä½†æˆ‘ä»¬çš„å®ç°æ¯æ¬¡éƒ½æ–°å»º

**ä½ç½®**ï¼š
- `KolodaCardsView.swift:326` - `let cardView = WordCardUIView()`

**å½±å“**ï¼š
- æ€§èƒ½é—®é¢˜ï¼ˆå¤§é‡åˆ›å»º/é”€æ¯è§†å›¾ï¼‰
- å†…å­˜å ç”¨
- åŠ¨ç”»å¯èƒ½ä¸æµç•…

**å»ºè®®**ï¼š
- å®ç°è§†å›¾é‡ç”¨æœºåˆ¶
- æˆ–è€…è®© Koloda ç®¡ç†è§†å›¾ç”Ÿå‘½å‘¨æœŸ

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜

#### 4. **é˜Ÿåˆ—ä¼˜åŒ–é€»è¾‘å¯èƒ½æœ‰é—®é¢˜**
**é—®é¢˜**ï¼š
- `optimizeQueue()` çš„é€»è¾‘çœ‹èµ·æ¥æ˜¯ä¸ºäº†é¿å…è¿ç»­ç›¸åŒå•è¯
- ä½†å®ç°å¯èƒ½ä¸å¤Ÿå®Œå–„ï¼Œbuffer çš„å¤„ç†é€»è¾‘å¯èƒ½æœ‰é—®é¢˜

**ä½ç½®**ï¼š
- `StudyViewModel.swift:196-218`

**å»ºè®®**ï¼š
- æ£€æŸ¥ä¼˜åŒ–é€»è¾‘æ˜¯å¦æ­£ç¡®
- æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯

---

#### 5. **æå‰æŒæ¡åçš„é˜Ÿåˆ—æ¸…ç†**
**é—®é¢˜**ï¼š
- å½“å•è¯æå‰æŒæ¡æ—¶ï¼Œä½¿ç”¨ `queue.removeAll { $0.word.id == wordId }`
- è¿™å¯èƒ½ä¼šç§»é™¤å¤šå¼ å¡ç‰‡ï¼Œä½† `completedCount` åªå¢åŠ  1

**ä½ç½®**ï¼š
- `StudyViewModel.swift:277-284`

**å½±å“**ï¼š
- è¿›åº¦ç»Ÿè®¡å¯èƒ½ä¸å‡†ç¡®
- ç”¨æˆ·å¯èƒ½æ„Ÿè§‰è¿›åº¦è·³è·ƒ

**å»ºè®®**ï¼š
- è®¡ç®—å®é™…ç§»é™¤çš„å¡ç‰‡æ•°ï¼Œæ›´æ–° `completedCount`
- æˆ–è€…è®°å½•æå‰æŒæ¡çš„å•è¯ï¼Œå•ç‹¬ç»Ÿè®¡

---

#### 6. **å®Œæˆæ£€æŸ¥çš„æ—¶æœº**
**é—®é¢˜**ï¼š
- å®Œæˆæ£€æŸ¥åœ¨ `handleSwipe` çš„æœ€å
- ä½†æ­¤æ—¶ `queue` å·²ç»ç§»é™¤äº†ä¸€å¼ å¡ç‰‡ï¼Œ`visibleCards` ä¹Ÿå·²ç»æ›´æ–°
- å¦‚æœ `queue.isEmpty && visibleCards.isEmpty`ï¼Œè¯´æ˜å·²ç»å®Œæˆ

**ä½ç½®**ï¼š
- `StudyViewModel.swift:316-323`

**å»ºè®®**ï¼š
- é€»è¾‘çœ‹èµ·æ¥æ˜¯æ­£ç¡®çš„ï¼Œä½†å¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—

---

### ğŸŸ¢ è½»å¾®é—®é¢˜

#### 7. **åº•éƒ¨å·¥å…·æ åŠŸèƒ½æœªå®ç°**
**é—®é¢˜**ï¼š
- å‘éŸ³ã€æ’¤å›ã€æ›´å¤šæŒ‰é’®éƒ½æ˜¯ç©ºçš„ `action: {}`

**ä½ç½®**ï¼š
- `KolodaCardsView.swift:178-211`

**å»ºè®®**ï¼š
- å®ç°è¿™äº›åŠŸèƒ½æˆ–æš‚æ—¶éšè—

---

#### 8. **é”™è¯¯å¤„ç†ä¸å¤Ÿå®Œå–„**
**é—®é¢˜**ï¼š
- å¾ˆå¤šåœ°æ–¹åªæ˜¯æ‰“å°æ—¥å¿—ï¼Œæ²¡æœ‰ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- æ•°æ®åº“æ“ä½œå¤±è´¥æ—¶ï¼Œç”¨æˆ·å¯èƒ½ä¸çŸ¥é“

**å»ºè®®**ï¼š
- æ·»åŠ é”™è¯¯æç¤º UI
- å®ç°é‡è¯•æœºåˆ¶

---

## âœ… åšå¾—å¥½çš„åœ°æ–¹

### 1. **æ¶æ„æ¸…æ™°**
- åˆ†å±‚æ˜ç¡®ï¼šSwiftUI â†’ UIKit â†’ ä¸šåŠ¡é€»è¾‘ â†’ æ•°æ®å±‚
- èŒè´£åˆ†ç¦»ï¼šView åªè´Ÿè´£å±•ç¤ºï¼ŒViewModel è´Ÿè´£é€»è¾‘

### 2. **çŠ¶æ€ç®¡ç†**
- ä½¿ç”¨ `@Published` å±æ€§ï¼Œè‡ªåŠ¨è§¦å‘ UI æ›´æ–°
- `visibleCards` æ˜¯ `queue.prefix(3)` çš„æ´¾ç”Ÿå±æ€§ï¼Œé¿å…é‡å¤

### 3. **æ•°æ®æŒä¹…åŒ–**
- æ»‘åŠ¨äº‹ä»¶å®æ—¶ä¿å­˜åˆ°æ•°æ®åº“
- å­¦ä¹ æŠ¥å‘Šç”Ÿæˆå’Œä¿å­˜é€»è¾‘å®Œæ•´

### 4. **ç­–ç•¥æ¨¡å¼**
- ä½¿ç”¨ `ExposureStrategy` çµæ´»è°ƒæ•´æ›å…‰ç­–ç•¥
- æ”¯æŒä¸åŒçš„å­¦ä¹ ç›®æ ‡

### 5. **è°ƒè¯•æ”¯æŒ**
- å¤§é‡ `#if DEBUG` æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•
- å…³é”®æ­¥éª¤éƒ½æœ‰æ—¥å¿—è¾“å‡º

---

## ğŸ”§ æ”¹è¿›å»ºè®®

### ä¼˜å…ˆçº§ 1ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

1. **ç»Ÿä¸€åœç•™æ—¶é—´è¿½è¸ª**
   ```swift
   // ç§»é™¤ Coordinator ä¸­çš„è®¡æ—¶é€»è¾‘
   // ç»Ÿä¸€ä½¿ç”¨ StudyViewModel çš„ DwellTimeTracker
   ```

2. **ä¿®å¤æ•°æ®åŒæ­¥**
   ```swift
   // Coordinator åº”è¯¥ç›´æ¥è§‚å¯Ÿ ViewModel çš„ visibleCards
   // æˆ–è€…ä½¿ç”¨ Combine çš„ @Published è‡ªåŠ¨åŒæ­¥
   ```

3. **ä¼˜åŒ–å¡ç‰‡è§†å›¾åˆ›å»º**
   ```swift
   // å®ç°è§†å›¾é‡ç”¨æ± 
   // æˆ–è€…è®© Koloda ç®¡ç†è§†å›¾ç”Ÿå‘½å‘¨æœŸ
   ```

### ä¼˜å…ˆçº§ 2ï¼ˆåº”è¯¥ä¿®å¤ï¼‰

4. **ä¿®å¤æå‰æŒæ¡çš„ç»Ÿè®¡**
   ```swift
   // è®¡ç®—å®é™…ç§»é™¤çš„å¡ç‰‡æ•°
   // æ›´æ–° completedCount å’Œ totalCount
   ```

5. **å®Œå–„é”™è¯¯å¤„ç†**
   ```swift
   // æ·»åŠ ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
   // å®ç°é‡è¯•æœºåˆ¶
   ```

### ä¼˜å…ˆçº§ 3ï¼ˆå¯ä»¥ä¼˜åŒ–ï¼‰

6. **å®ç°åº•éƒ¨å·¥å…·æ åŠŸèƒ½**
   - å‘éŸ³åŠŸèƒ½
   - æ’¤å›åŠŸèƒ½
   - æ›´å¤šé€‰é¡¹

7. **ä¼˜åŒ–é˜Ÿåˆ—ç®—æ³•**
   - æ”¹è¿› `optimizeQueue()` é€»è¾‘
   - æ·»åŠ å•å…ƒæµ‹è¯•

8. **æ€§èƒ½ä¼˜åŒ–**
   - å‡å°‘ä¸å¿…è¦çš„è§†å›¾æ›´æ–°
   - ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢

---

## ğŸ“ æ€»ç»“

### æ•´ä½“è¯„ä»·ï¼šâ­â­â­â­ (4/5)

**ä¼˜ç‚¹**ï¼š
- æ¶æ„æ¸…æ™°ï¼Œåˆ†å±‚åˆç†
- çŠ¶æ€ç®¡ç†è§„èŒƒ
- æ•°æ®æŒä¹…åŒ–å®Œæ•´
- ç­–ç•¥æ¨¡å¼ä½¿ç”¨å¾—å½“

**ç¼ºç‚¹**ï¼š
- åœç•™æ—¶é—´è¿½è¸ªé‡å¤
- æ•°æ®åŒæ­¥å¯èƒ½æœ‰é—®é¢˜
- å¡ç‰‡è§†å›¾åˆ›å»ºæ•ˆç‡ä½
- éƒ¨åˆ†åŠŸèƒ½æœªå®ç°

**å»ºè®®**ï¼š
ä¼˜å…ˆä¿®å¤æ•°æ®åŒæ­¥å’Œåœç•™æ—¶é—´è¿½è¸ªé—®é¢˜ï¼Œè¿™äº›æ˜¯æ ¸å¿ƒåŠŸèƒ½ã€‚å…¶ä»–é—®é¢˜å¯ä»¥é€æ­¥ä¼˜åŒ–ã€‚

---

**åˆ†ææ—¶é—´**ï¼š2025-11-08  
**åˆ†æäºº**ï¼šAI Assistant

