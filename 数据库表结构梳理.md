# NFwords 数据库表结构梳理（最新版）

> 完整梳理前后端所有数据表及其关系

**更新时间**：2024-10-31  
**更新说明**：
- ✅ 新增单词额度机制
- ✅ 词汇包全部免费（删除付费字段）
- ✅ 简化用户词书关系（正在背/已背过）
- ✅ 曝光事件改为iOS生成，后端仅接收

---

## 📊 数据库架构总览

```
┌─────────────────────────────────────────────────────────────┐
│                    NFwords 数据架构                          │
└─────────────────────────────────────────────────────────────┘

┌────────────────────────┐          ┌────────────────────────┐
│   后端数据库（SQLite）  │          │  iOS本地数据库（SQLite）│
│   存储在阿里云服务器     │ ←同步→   │  存储在用户iPhone上      │
│   多用户共享             │          │  单用户专属              │
└────────────────────────┘          └────────────────────────┘
```

---

## 🖥️ 后端数据库（服务器端）

### 核心业务表（10张）

#### 1. **users** - 用户账户表 ⭐ 核心改动
```sql
用途：存储用户基本信息、会员状态、单词额度、学习统计
关键字段：
  - phone (手机号登录)
  - membership_type (free/premium/lifetime) - 仅Apple付费
  - apple_receipt_data (Apple IAP凭证)
  
  ⭐ 单词额度机制（NEW）：
  - available_words (拥有的单词数 - 总额度)
  - words_used (已使用的单词数 - 学过的)
  - planned_words (规划中的单词数 - 还没学) ⭐ 最新
  - total_words_granted (累计发放的单词数)
  - last_words_grant_at (上次发放时间)
  
  ⭐ 约束：available_words >= words_used + planned_words
  
  - login_days (累计登录天数)
  - consecutive_login_days (连续登录天数)
  - total_words_learned (总学习单词数)
  - current_streak (连续学习天数)
  
数据规模：预计10万+用户
是否同步：❌ 纯后端（但available_words需要同步到iOS）
```

#### 2. **orders** - 订单表
```sql
用途：记录会员购买订单
关键字段：
  - order_no (订单号)
  - product_id (monthly/yearly/lifetime)
  - payment_method (alipay/wechat/apple_iap)
  - payment_status (pending/paid/failed)
  - receipt_data (Apple IAP凭证)
  
数据规模：随交易增长
是否同步：❌ 纯后端
```

#### 3. **vocabulary_packs** - 词汇包元数据表 ⭐ 简化版
```sql
用途：存储所有词汇包的元信息（全部免费）
关键字段：
  - pid (词汇包唯一ID)
  - title (如"CET4词汇")
  - version (如"1.0.0")
  - words_count (包含多少个单词)
  - entries_json (JSON数组，直接存储wid列表) ⭐ NEW
  - hash (SHA-256哈希校验)
  
  ❌ 删除字段：
  - is_free（全部免费）
  - required_membership（无需会员）
  - pack_json_url（不需要URL）
  
数据规模：预计100-200个词汇包
是否同步：✅ 需要同步到iOS
```

#### 4. **user_packs** - 用户词书关系表 ⭐ 简化版
```sql
用途：记录用户拥有的词书（正在背/已背过）
关键字段：
  - user_id (哪个用户)
  - pack_id (哪个词书)
  - status (learning正在背 / completed已背过) ⭐ NEW
  - progress_percent (进度百分比 0.0-100.0) ⭐ NEW
  - learned_count/total_count (数量统计)
  - completed_at (标记为已背过的时间)
  
  ❌ 删除字段：
  - is_active（用status替代）
  - use_custom_order（不支持自定义顺序）
  - custom_order_json（不支持）
  - current_position（不需要记录位置）
  
数据规模：每个用户5-10个词书
是否同步：✅ 需要同步到iOS
```

#### 5. **word_plans** - 单词规划表 ⭐ NEW
```sql
用途：记录用户计划学习的词书（占用单词额度）
关键字段：
  - user_id, pack_id
  - plan_status (planned规划中 / started已开始)
  - total_words (该词书总单词数)
  - learned_words (已学习的单词数)
  - remaining_words (剩余规划单词数)
  - planned_at (加入规划的时间)
  
核心逻辑：
  ✅ 添加到规划时：user.planned_words += pack.words_count
  ✅ 开始学习时：plan_status = 'started'
  ✅ 学习每个单词：user.planned_words -= 1, user.words_used += 1
  ✅ 删除规划：user.planned_words -= remaining_words
  
数据规模：每个用户5-10条
是否同步：✅ 需要同步到iOS
```

#### 6. **learning_progress** - 学习进度表（核心）⭐ UPDATED
```sql
用途：记录每个用户对每个单词的详细学习情况
关键字段：
  - user_id, pack_id, wid (三元组唯一标识)
  - familiarity (0-5熟悉度)
  - total_exposure_count (总曝光次数) ← 新增
  - total_exposure_time_seconds (总曝光时长) ← 新增
  - learning_phase (initial/reinforcement/consolidation/maintenance) ← 新增
  - ease_factor (难度因子) ← 新增
  - next_exposure_at (下次曝光时间) ← 新增
  - exposure_rate (曝光率 0.0-1.0) ⭐ 最新
  - exposure_rate_percent (曝光率百分比 0.0-100.0) ⭐ 最新
  
数据规模：巨大！用户数 × 每个词书3000+ = 数百万行
是否同步：✅ 需要同步（核心数据）
```

#### 7. **exposure_events** - 曝光事件表 ⭐ 仅接收上报
```sql
用途：接收iOS上报的曝光数据（用于大数据分析）
关键字段：
  - user_id, pack_id, wid
  - exposure_type (flashcard/sentence/story/article等)
  - dwell_time_seconds (停留时长 - 关键指标！)
  - interaction_type (view/skip/click/favorite/share)
  - exposed_at (iOS端的曝光时间)
  - reported_at (上报到服务器的时间) ⭐ NEW
  - session_id (会话ID)
  - device_info (设备信息) ⭐ NEW
  
重要说明：
  ⚠️ 该表数据由iOS端生成，后端仅接收批量上报
  ⚠️ iOS本地表名：exposure_events_local
  
数据规模：海量！每天每用户50-100条 = 每月千万级
是否同步：❌ 单向上报（iOS → 后端）
```

#### 8. **pack_downloads** - 下载记录表
```sql
用途：统计词汇包下载次数
关键字段：
  - user_id, pack_id
  - downloaded_at
  
数据规模：中等
是否同步：❌ 纯后端统计
```

#### 9. **system_configs** - 系统配置表
```sql
用途：存储系统级配置（key-value）
关键字段：
  - key (如 "min_app_version")
  - value
  - description
  
数据规模：小（几十条）
是否同步：✅ 部分配置需要同步到客户端
```

#### 10. **push_notifications** - 推送通知表
```sql
用途：记录发送的推送通知
关键字段：
  - user_id
  - title, body
  - status (pending/sent/failed)
  - sent_at
  
数据规模：大量
是否同步：❌ 纯后端
```

---

## 📱 iOS客户端本地数据库

### 核心本地表（7张）

#### 1. **local_packs** - 本地词汇包表 ⭐ 与后端一致
```sql
用途：存储用户本地的词汇包信息（与后端user_packs结构一致）
关键字段：
  - pid (与后端vocabulary_packs.pid对应)
  - title, description, category, level
  - status (learning正在背 / completed已背过) ⭐ 与后端一致
  - progress_percent (进度百分比 0.0-100.0) ⭐ 与后端一致
  - learned_count/total_count (数量统计)
  - completed_at (标记为已背过的时间)
  - entries_json (wid数组，从后端同步)
  - version, hash (版本和校验)
  
  ❌ 删除字段（与后端保持一致）：
  - is_active（用status替代）
  - use_custom_order（不支持）
  - custom_order_json（不支持）
  - current_position（不需要）
  - pack_json_cache（不需要）
  
数据来源：从后端vocabulary_packs + user_packs同步
是否离线：✅ 完全离线可用
```

#### 2. **word_plans_local** - 单词规划表（本地）⭐ NEW（支持离线）
```sql
用途：记录用户计划学习的词书（支持离线规划）
关键字段：
  - pid
  - plan_type (auto自动 / manual手动) ⭐
  - plan_status (pending待确认 / confirmed已确认) ⭐
  - planned_wids_json (具体的wid列表) ⭐
  - total_words (该词书总单词数)
  - learned_words (已学习数)
  - remaining_words (剩余规划数)
  
  ⭐ 离线同步字段（NEW）：
  - sync_status (pending待同步 / synced已同步 / failed失败)
  - last_sync_attempt (最后同步尝试时间)
  - sync_error (同步失败原因)
  - backend_plan_id (后端plan_id)
  - was_offline (是否离线创建 0/1)
  
数据来源：用户添加词书到规划（支持离线）
数据规模：每个用户5-10条
是否离线：✅ 离线可用，联网后自动同步
```

#### 3. **word_cache** - 单词内容缓存表
```sql
用途：缓存已访问过的单词详细信息
关键字段：
  - wid (单词ID)
  - word (单词本身)
  - phonetic (音标)
  - translations_json (释义)
  - phrases_json (短语)
  - scenes_json (例句)
  - frequency (词频)
  - audio_url (发音URL)
  - cached_at (缓存时间)
  - access_count (访问次数)
  
数据来源：从words-*.jsonl文件加载
数据规模：按需缓存，最多1000个单词
是否离线：✅ 完全离线（从App Bundle读取）
```

#### 4. **word_exposure** - 单词曝光数据表（本地核心）⭐ NEW
```sql
用途：本地记录每个单词的曝光统计和学习状态
关键字段：
  - pid, wid
  - total_exposure_count (总曝光次数)
  - total_dwell_time (总停留时长)
  - avg_dwell_time (平均停留时长)
  - familiarity (0-5熟悉度)
  - learning_phase (学习阶段)
  - learned (是否已学会)
  - first_exposed_at (首次曝光时间)
  - last_exposed_at (最后曝光时间)
  - next_exposure_at (下次计划曝光时间)
  - ease_factor (难度因子)
  - in_today_plan (是否在今日计划中)
  - plan_date (计划日期)
  
数据来源：本地产生 + 从后端learning_progress同步
数据规模：每个词书3000+单词
是否离线：✅ 本地生成，定期同步到后端
```

#### 5. **daily_plans** - 每日学习计划表 ⭐ NEW
```sql
用途：每日生成的学习计划（今天要曝光哪些单词）
关键字段：
  - plan_date (日期 YYYY-MM-DD)
  - pid (词书ID)
  - planned_wids_json (今日计划的所有wid，JSON数组)
  - new_words_count (新单词数)
  - review_words_count (复习单词数)
  - completed_count (已完成数)
  - total_exposure_time (今日总学习时长)
  - status (active/completed/cancelled)
  
数据来源：本地算法生成
数据规模：每天每个词书1条
是否离线：✅ 完全本地
```

#### 6. **exposure_events_local** - 曝光事件明细表（本地生成，支持离线）⭐ 核心
```sql
用途：iOS本地详细记录每次曝光事件（完全离线可用）
关键字段：
  - pid, wid
  - exposure_type (flashcard/sentence/story等)
  - dwell_time_seconds (停留时长)
  - interaction (view/skip/click/favorite)
  - exposed_at (时间戳)
  - session_id (会话ID)
  - plan_date (所属计划日期)
  
  ⭐ 离线上报管理（NEW）：
  - is_reported (是否已上报到后端 0/1)
  - reported_at (上报成功时间)
  
离线逻辑：
  ✅ 离线学习：正常记录到本地表
  ✅ 联网后：积累50条或退出App时批量上报
  ✅ 上报成功：标记is_reported=1
  ✅ 定期清理：30天后删除已上报数据
  ✅ 失败重试：网络恢复时自动重试
  
数据来源：iOS本地产生（离线可用）
数据规模：大量（每天50-100条）
是否离线：✅ 完全离线，联网后批量上报
```

#### 7. **packs** - 词汇包元数据（本地缓存）
```sql
用途：缓存manifest.json中的词汇包列表
关键字段：
  - pid, title, version
  - released_at, downloaded_at
  - is_active (是否在学习)
  - entries_json (wid数组)
  - learned_count, total_count
  
数据来源：从manifest.json和pack.json
是否离线：✅ 本地缓存
```

---

## 🔄 数据同步策略

### 1. 从后端同步到iOS

| 数据 | 同步时机 | 同步方式 | 频率 |
|------|---------|---------|------|
| **manifest.json** | App启动 | GET /api/v1/manifest.json | 每24小时 |
| **user_packs** | 用户登录、新增词书 | GET /api/v1/packs/user | 按需 |
| **learning_progress** | 用户登录、每日同步 | GET /api/v1/progress/sync | 每天1次 |
| **system_configs** | App启动 | GET /api/v1/configs | 每次启动 |

### 2. 从iOS上报到后端

| 数据 | 上报时机 | 上报方式 | 频率 |
|------|---------|---------|------|
| **exposure_events** | 积累50条或退出App | POST /api/v1/exposure/track (批量) | 定期批量 |
| **learning_progress** | 每日结束或退出App | POST /api/v1/progress/sync | 每天1次 |
| **user_packs配置** | 用户调整顺序后 | PUT /api/v1/packs/{pid}/order | 实时 |

### 3. 双向同步（冲突解决）

```swift
// learning_progress冲突解决策略
if local.updated_at > remote.updated_at {
    // 本地更新，上传
    uploadToBackend(local)
} else if remote.updated_at > local.updated_at {
    // 服务器更新，下载
    downloadFromBackend(remote)
} else {
    // 时间相同，合并
    merged = merge(local, remote)
    // 合并策略：
    // - total_exposure_count = max(local, remote)
    // - familiarity = max(local, remote)
    // - last_exposed_at = max(local, remote)
}
```

---

## 📊 数据流转关系图

```
┌─────────────────────────────────────────────────────────┐
│                     数据流转全景图                       │
└─────────────────────────────────────────────────────────┘

1️⃣ 用户下载词汇包
   iOS App
   └─> GET /api/v1/manifest.json (获取可用词汇包)
   └─> POST /api/v1/packs/{pid}/download (记录下载)
   └─> 下载 pack.json (从CDN)
   └─> 存入 local_packs 表

2️⃣ 生成今日计划
   iOS App本地算法
   └─> 读取 word_exposure 表
   └─> 根据 learning_phase 和 next_exposure_at 筛选单词
   └─> 生成 daily_plans 表记录

3️⃣ 用户学习（核心流程）
   用户滑动卡片
   └─> 记录 exposure_events_local (本地明细)
   └─> 更新 word_exposure (累加曝光次数、时长)
   └─> 重新计算 next_exposure_at (SM-2算法)
   └─> 更新 local_packs (进度)

4️⃣ 数据同步
   后台定时任务
   └─> 批量上报 exposure_events_local → 后端 exposure_events
   └─> 同步 word_exposure → 后端 learning_progress
   └─> 同步 local_packs → 后端 user_packs

5️⃣ 后端分析
   后端AI分析引擎
   └─> 分析 exposure_events (大数据)
   └─> 计算用户学习模式
   └─> 优化曝光策略
   └─> 生成个性化推荐
```

---

## 🎯 核心数据表关系

### 后端表关系

```
users (用户)
  ├──< user_packs (用户拥有的词书)
  │     └──> vocabulary_packs (词书元数据)
  ├──< learning_progress (学习进度)
  │     ├──> vocabulary_packs (哪个词书)
  │     └──> [wid] (哪个单词)
  ├──< exposure_events (曝光事件)
  │     ├──> vocabulary_packs
  │     └──> [wid]
  ├──< orders (订单)
  └──< push_notifications (推送)
```

### iOS本地表关系

```
local_packs (本地词书)
  ├──< word_exposure (单词曝光数据)
  │     └──> [从 word_cache 读取单词详情]
  ├──< daily_plans (每日计划)
  │     └──> word_exposure (选择今日要曝光的单词)
  └──< exposure_events_local (曝光明细)
        └──> word_exposure (汇总到这里)

word_cache (单词缓存)
  └──> [从App Bundle的 words-*.jsonl 读取]
```

---

## 💾 存储空间估算

### 后端数据库（SQLite）

| 表 | 每行大小 | 行数估算 | 总大小 |
|----|---------|---------|-------|
| users | 500B | 100,000 | 50MB |
| orders | 800B | 50,000 | 40MB |
| vocabulary_packs | 2KB | 200 | 400KB |
| user_packs | 1KB | 500,000 | 500MB |
| learning_progress | 500B | 100M | 50GB ⚠️ |
| exposure_events | 300B | 1B | 300GB ⚠️ |
| 其他 | - | - | 10MB |
| **总计** | | | **~350GB** |

**优化方案**：
- learning_progress：定期归档旧数据
- exposure_events：保留30天数据，其余归档到对象存储

### iOS本地数据库（SQLite）

| 表 | 每行大小 | 行数估算 | 总大小 |
|----|---------|---------|-------|
| local_packs | 2KB | 10 | 20KB |
| word_cache | 1.5KB | 1,000 | 1.5MB |
| word_exposure | 400B | 10,000 | 4MB |
| daily_plans | 10KB | 30 | 300KB |
| exposure_events_local | 200B | 5,000 | 1MB |
| **总计** | | | **~7MB** |

**App Bundle额外占用**：
- words-*.jsonl：50-100MB
- 音频文件（可选）：100-200MB
- **总计App大小**：150-300MB

---

## ✅ 梳理总结（最终版）

### 后端数据库（10张表）

**核心业务表**：
1. users - 用户账户（含单词额度）⭐ 新增planned_words
2. orders - 订单（仅Apple IAP）
3. vocabulary_packs - 词汇包元数据（全部免费）⭐
4. user_packs - 用户词书关系（正在背/已背过）⭐
5. word_plans - 单词规划表 ⭐ NEW
6. learning_progress - 学习进度（核心）⭐ 新增exposure_rate
7. exposure_events - 曝光事件（仅接收上报）⭐

**辅助表**：
8. pack_downloads - 下载统计
9. system_configs - 系统配置
10. push_notifications - 推送通知

### iOS本地数据库（7张表）

**核心学习表**：
1. local_packs - 本地词书配置（与后端一致）⭐
2. word_plans_local - 单词规划表（本地）⭐ NEW
3. word_exposure - 单词曝光数据（核心）⭐
4. daily_plans - 每日计划 ⭐
5. exposure_events_local - 曝光明细（本地生成）⭐

**缓存表**：
6. word_cache - 单词内容缓存
7. packs - 词汇包元数据缓存

### 关键设计理念

1. **离线优先**：iOS端可完全离线学习
2. **定期同步**：每天1次全量同步，实时上报核心事件
3. **分层存储**：后端存全量，iOS端按需缓存
4. **大数据分析**：exposure_events用于深度分析
5. **冲突解决**：时间戳 + 最大值合并策略

---

**现在清楚了吗？** 🎉

